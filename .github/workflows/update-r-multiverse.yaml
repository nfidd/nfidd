name: Update R-multiverse Production Snapshot

on:
  schedule:
    - cron: '0 10 1 * *'
  workflow_dispatch:

jobs:
  check-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'

      - name: Get current snapshot date from DESCRIPTION
        id: current
        run: |
          CURRENT_DATE=$(grep -oE 'production\.r-multiverse\.org/[0-9]{4}-[0-9]{2}-[0-9]{2}' DESCRIPTION | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}')
          if [ -z "$CURRENT_DATE" ]; then
            echo "::error::Failed to extract current snapshot date from DESCRIPTION"
            exit 1
          fi
          echo "date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "Current snapshot: $CURRENT_DATE"

      - name: Discover latest production snapshot
        id: latest
        run: |
          LATEST_DATE=$(curl -s https://r-multiverse.org/production.html | \
            grep "deployed on" | \
            grep -oE '20[0-9]{2}-[0-9]{2}-[0-9]{2}' | \
            head -1)

          if [ -z "$LATEST_DATE" ]; then
            echo "::error::Failed to discover latest production snapshot date"
            exit 1
          fi

          echo "date=$LATEST_DATE" >> $GITHUB_OUTPUT
          echo "Latest production snapshot: $LATEST_DATE"

      - name: Compare dates
        id: compare
        run: |
          CURRENT="${{ steps.current.outputs.date }}"
          LATEST="${{ steps.latest.outputs.date }}"

          if [ "$CURRENT" != "$LATEST" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Update needed: $CURRENT -> $LATEST"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Already up to date: $CURRENT"
          fi

      - name: Verify cmdstanr availability in new snapshot
        if: steps.compare.outputs.needs_update == 'true'
        id: verify
        run: |
          LATEST="${{ steps.latest.outputs.date }}"
          REPO_URL="https://production.r-multiverse.org/$LATEST"

          if Rscript -e "
            tryCatch({
              pkgs <- available.packages(repos = '$REPO_URL')
              if ('cmdstanr' %in% pkgs[, 'Package']) {
                cat('cmdstanr found\n')
                quit(status = 0)
              } else {
                cat('cmdstanr not found\n')
                quit(status = 1)
              }
            }, error = function(e) {
              cat('Error checking snapshot:', conditionMessage(e), '\n')
              quit(status = 1)
            })
          "; then
            echo "available=true" >> $GITHUB_OUTPUT
            VERSION=$(Rscript -e "cat(available.packages(repos = '$REPO_URL')['cmdstanr', 'Version'])")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "cmdstanr $VERSION is available in $LATEST snapshot"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "::warning::cmdstanr is not available in $LATEST snapshot yet"
            exit 1
          fi

      - name: Update DESCRIPTION and workflow files
        if: steps.compare.outputs.needs_update == 'true' && steps.verify.outputs.available == 'true'
        run: |
          CURRENT="${{ steps.current.outputs.date }}"
          LATEST="${{ steps.latest.outputs.date }}"

          sed -i "s|production\.r-multiverse\.org/$CURRENT|production.r-multiverse.org/$LATEST|g" DESCRIPTION
          find .github/workflows -name "*.yaml" -type f -exec \
            sed -i "s|production\.r-multiverse\.org/$CURRENT|production.r-multiverse.org/$LATEST|g" {} \;

          git diff

      - name: Create Pull Request
        if: steps.compare.outputs.needs_update == 'true' && steps.verify.outputs.available == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "Update R-multiverse production snapshot to ${{ steps.latest.outputs.date }}"
          branch: update-r-multiverse-${{ steps.latest.outputs.date }}
          delete-branch: true
          title: "Update R-multiverse production snapshot to ${{ steps.latest.outputs.date }}"
          body: |
            Automated PR to update the R-multiverse production snapshot.

            - Update from `${{ steps.current.outputs.date }}` to `${{ steps.latest.outputs.date }}`
            - Verified cmdstanr ${{ steps.verify.outputs.version }} is available
          labels: dependencies
          token: ${{ secrets.GITHUB_TOKEN }}
